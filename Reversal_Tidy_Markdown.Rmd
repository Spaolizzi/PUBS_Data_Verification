---
title: "Reversal Data Cleaning and Diagnostics"
author: "Sophie Paolizzi"
date: "8/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE)
##Load Packages and source scripts
pacman::p_load(tidyverse, readr, janitor, ggplot2,wesanderson, cowplot, flextable)
setwd("~/github_repos/PUBS_Data_Verification/")
#source("Tidy_functions_PUBS.R")

#load data
reversal_data <- data.table::fread("pubs_pilot_reversal_task_forpilot_7.4.21_raw_21_07_29.csv", fill = TRUE)
reversal_data <- reversal_data %>% row_to_names(4) %>% group_by(subject) %>% filter(n() >= 200)
```

This markdown generates diagnostic checks for the PUBS data.

This chunk tidies the data from the reversal task. I'd like to have this spit out errors too, when possible. 
```{r cars}
#drop rows that aren't useful - will delete from main script
reversal_data <- reversal_data %>% select(!c(practiceInstructionIndex,blockName, 
                                             ITI, numTrialEachBlock, instructionIndex, 
                                             isThisTrialPractice, trialCounter, blockNumber, build, experimentName,
                                             picture.Left.currentvalue, picture.Right.currentvalue)) 

##long pipe for tidying data, not by block
distinct <- reversal_data %>% 
  group_by(subject, block_number, trial_number) %>% ##group by subject and block to prevent weirdness
  mutate(trial_number = as.numeric(trial_number)) %>%  mutate(block_number = as.numeric(block_number)) %>% mutate(reversalnumber = as.numeric(reversalnumber)) %>% ##change needed things to numeric
  arrange(subject, block_number, trial_number) %>% slice(which.max(centsearned)) %>% ## arrange in order based on grouping
  mutate(trial_latency = ifelse(rightleft == "left", trial.presentation_left.latency, trial.presentation_right.latency)) %>% ## combine latencies to create overall trial latency
  mutate(trial_response = ifelse(rightleft == "left", trial.presentation_left.response, trial.presentation_right.response)) %>% ## combine responses to create overall trial response
  mutate(trial_response = ifelse(trial_response == 45, "left", trial_response)) %>% #change name of response variable
  mutate(trial_response = ifelse(trial_response == 50, "right", trial_response)) %>% #change name of response variable
  mutate(trial_response = ifelse(trial_response == 0, "noresponse", trial_response)) %>% #change name of response variable
  mutate(total_trialnum = ifelse(block_number > 1, trial_number + (80*(block_number-1)), trial_number)) %>% #add running counter for total trials
  mutate(reversal_trial = ifelse(trial_number == reversalnumber , trial_number, NA)) %>% #change name of response variable
  select(!c(trial.presentation_left.latency, trial.presentation_right.latency, trial.presentation_left.response, trial.presentation_right.response)) %>% # delete extra columns for conciseness
  filter(!total_trialnum > 240 && !block_number > 3) %>% filter(!trial_number == 0) %>% #removing things we don't need
  group_by(subject, block_number) %>% mutate(percent_correct_block = as.numeric(numbercorrect)/80) %>% ##percentage correct across block
  mutate(task_phase = ifelse(trial_number <= reversalnumber, "Acquisition", "Reversal")) #note which block they're in
  

### This pipe readies the data for the first scatterplot, giving a first look at of performance
distinct <- distinct %>% group_by(subject, block_number) %>% #grouping again
  mutate(numbercorrect = as.numeric(numbercorrect)) %>% # get things as.numeric
  mutate(phase_trialnum = ifelse(task_phase == "Reversal", trial_number - reversalnumber, trial_number)) %>%
  mutate(numbercorrect_acq = ifelse(as.numeric(trial_number) == as.numeric(reversalnumber), numbercorrect, 0)) %>%
  mutate(numbercorrect_reversal = ifelse(task_phase == "Reversal", numbercorrect - max(numbercorrect_acq), 0)) %>%
  mutate(numbercorrect_phase = ifelse(task_phase == "Reversal", numbercorrect_reversal, numbercorrect)) %>% 
  mutate(ResponseCorrect = as.numeric(isResponseCorrect)) %>%
  select(!c(numbercorrect_acq, numbercorrect_reversal)) %>% #phase_numbercorrect
  group_by(subject, block_number, task_phase) %>%
  mutate(reached_criterion = ifelse(as.numeric(numbercorrect_phase) > 10, phase_trialnum, NA)) %>%
  mutate(percent_correct_phase = as.numeric(numbercorrect_phase)/max(as.numeric(phase_trialnum)))  %>% 
  mutate(diff_numbercorrect_phase = numbercorrect_phase - lag(numbercorrect_phase)) %>% 
   ungroup() %>%
  group_by(
    subject, 
    task_phase, 
    block_number, 
    grp = lag(cumsum(isResponseCorrect == -1), default = 0)
  ) %>% 
  mutate(ConsecutiveCorrect = ifelse(isResponseCorrect == -1, 0, cumsum(isResponseCorrect))) %>%
  mutate(ConsecutiveCorrect = ifelse(isResponseCorrect == 0, NA, ConsecutiveCorrect)) %>%
  ungroup() %>% 
  select(-grp)




obj <- distinct %>% group_by(subject, block_number, task_phase) %>% 
  summarise(reached_criterion = min(reached_criterion, na.rm=TRUE), 
                              percent_correct_phase = max(percent_correct_phase),
                              ConsecutiveCorrect = max(ConsecutiveCorrect),
                              trial_number = max(phase_trialnum)) %>% 
  mutate(above_threshold = ifelse(percent_correct_phase >= .50, "Above", "Below"))
```


This chunk creates diagnostic plots for data from the reversal task.

```{r pressure}

subjects <- unique(distinct$subject); cowplot_list <- list(); plot_subjects <- list()

for (i in subjects) {
  
  scatter <- ggplot(distinct %>% dplyr::filter(subject == i), aes(x=trial_number, y=trial_response, colour = isResponseCorrect)) + 
     geom_point() + 
     geom_vline(aes(xintercept = reversal_trial, color = "Reversal Point")) + 
     scale_color_manual(labels = c("Incorrect", "Correct", "Reversal Point"),values = (wes_palette("Cavalcanti1")[c(5,4,2)])) + 
     xlab("Trial Number") + ylab("Response Type") + ggtitle(i) +
     facet_wrap(~block_number)
  scatter[[i]] <- scatter

hist <- obj %>% filter(subject == i) %>% group_by(block_number) %>% ggplot(aes(y=percent_correct_phase, x = task_phase, fill = above_threshold)) +
  geom_bar(stat = "identity") + 
  scale_fill_manual(values = (wes_palette("Cavalcanti1")[c(4,5)])) + 
 ylab("Percentage Correct") + xlab("") +  facet_grid(~ block_number)
 hist[[i]] <- hist
 plot_subjects[[i]] <- list(scatter, hist) 
 
 cowplot <- cowplot::plot_grid(scatter, hist, nrow = 2)
 cowplot_list[[i]] <- cowplot
}

colormatrix <- ifelse(obj$above_threshold == "Below", wes_palette("Cavalcanti1")[c(4)], "white") ##potentially save these as bad_blocks vector
tab <- obj %>% flextable() %>% bg(j = 1:8, bg=colormatrix)

tab
cowplot_list

```

Based on the graphs generated above, it seems most people were able to learn the task contingencies relatively quickly. Participants performed
